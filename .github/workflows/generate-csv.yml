name: Generate CSV and Save to Repository
on:
  schedule:
    - cron: '40 16 * * *'  # 18:40 Î•Î»Î»Î¬Î´Î±
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      # 1. Checkout Î¼Îµ write permissions
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. Î£Î²Î®Î½ÎµÎ¹ Ï„Î¿ Ï€Î±Î»Î¹ÏŒ data.csv (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
      - name: Delete old CSV if exists
        run: |
          if [ -f "data.csv" ]; then
            echo "ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï€Î±Î»Î¹Î¿Ï data.csv"
            rm data.csv
          fi
      
      # 3. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î¿ Î½Î­Î¿ CSV
      - name: Create new CSV file
        run: |
          echo "Date,Company,Amount" > data.csv
          echo "$(date '+%Y-%m-%d'),Company A,1000" >> data.csv
          echo "$(date '+%Y-%m-%d'),Company B,2000" >> data.csv
          echo "ğŸ“ CSV Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ: $(date)"
          cat data.csv
      
      # 4. Commit ÎºÎ±Î¹ push Ï„Î¿ CSV ÏƒÏ„Î¿ repository
      - name: Save CSV to repository
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          
          git add data.csv
          
          # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î»Î»Î±Î³Î­Ï‚
          if git status --porcelain | grep -q 'data.csv'; then
            git commit -m "ğŸ“Š Update CSV data $(date '+%Y-%m-%d %H:%M')"
            git push
            echo "âœ… CSV Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿ repository"
          else
            echo "âš ï¸ Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î»Î»Î±Î³Î­Ï‚ Î³Î¹Î± commit"
          fi
      
      # 5. (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬) Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Ï‰Ï‚ artifact Î³Î¹Î± Power Automate
      - name: Upload artifact for Power Automate
        uses: actions/upload-artifact@v4
        with:
          name: csv-data
          path: data.csv
